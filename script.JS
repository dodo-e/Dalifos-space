// =======================================================
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª
// =======================================================
const apiKey = '45a30abbea3343b8b930619bc03ab986'; 
const queryTopic = 'technology'; 
const newsApiUrl = `https://newsapi.org/v2/top-headlines?country=us&category=${queryTopic}&pageSize=5&apiKey=${apiKey}`;

// ğŸ’¡ Ù…Ø­ØªÙˆÙ‰ HTML Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ·Ø¨ÙŠÙ‚ D Apps
const dAppsHTMLContent = `        <style>body{background-color: rgba(0, 0, 0, 0.493);}</style>
    <h1>WELCOME TO D APPS</h1>
    <p>D apps is a web application that allows you to access and use various decentralized applications (DApps) built on it. .</p>
    <h2>famous apps</h2>
    <ul>
        <li><a href="Apps/calculator.html" target="_Self">DApp 1</a> - A popular decentralized finance application.</li>
        <li><a href="https://example-dapp2.com" target="_blank">DApp 2</a> - A well-known NFT marketplace.</li>
        <li><a href="https://example-dapp3.com" target="_blank">DApp 3</a> - A leading decentralized social media platform.</li>
    </ul>
`;


// =======================================================
// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†ÙˆØ§ÙØ°
// =======================================================
let newsWindowElement;
let dAppsWindowElement; 

// =======================================================
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙØªØ­ ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…Ø©
// =======================================================

function closeWindow(windowElement) {
    if (windowElement) {
        windowElement.style.display = 'none';
    }
}

// ------------------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø®Ø¨Ø§Ø± -------------------
function openNewsWindow() {
    if (newsWindowElement) {
        newsWindowElement.style.display = 'block';
        fetchLatestNews(); 
    }
}

function closeNewsWindow() {
    closeWindow(newsWindowElement);
}

// ------------------- ÙˆØ¸Ø§Ø¦Ù D Apps -------------------
function openDAppsWindow() {
    if (dAppsWindowElement) {
        // 1. Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
        dAppsWindowElement.style.display = 'block';
        
        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù€ HTML Ø§Ù„Ù…Ø®ØµØµ
        const contentContainer = document.getElementById('d-apps-content');
        if (contentContainer) {
            contentContainer.innerHTML = dAppsHTMLContent;
        }
    }
}

function closeDAppsWindow() {
    closeWindow(dAppsWindowElement);
}

// =======================================================
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
// =======================================================
function updateTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const timeString = `${hours}:${minutes}:${seconds}`; // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
    const timeElement = document.getElementById('digital-time');
    if (timeElement) {
        timeElement.textContent = timeString; 
    }
}

function updateDate() {
    const now = new Date();
    const locale = 'en-us'; 
    const options = { weekday: 'short', year: 'numeric', month: 'numeric', day: 'numeric' };
    const dateString = now.toLocaleDateString(locale, options); 
    const dateElement = document.getElementById('current-date');
    if (dateElement) {
        dateElement.textContent = dateString;
    }
}

// =======================================================
// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± (News Fetch)
// =======================================================
async function fetchLatestNews() {
    const newsContainer = document.getElementById('news-feed');
    
    try {
        const response = await fetch(newsApiUrl);
        
        if (!response.ok) {
             const errorData = await response.json();
             let errorMessage = `ops, loading news, please wait (${response.status})`;
             
             if (response.status === 401) {
                 errorMessage += ' - key not true.';
             } else if (response.status === 404) {
                 errorMessage += ' - (problem with API (wrong).';
             } else if (response.status === 429) {
                 errorMessage += ' - you can not use this number of calls.';
             }
             
             throw new Error(errorMessage);
        }
        
        const data = await response.json();
        const articles = data.articles.slice(0, 5); 

        newsContainer.innerHTML = ''; 

        articles.forEach(article => {
            const newsItem = document.createElement('div');
            newsItem.classList.add('news-item');
            
            const newsImage = article.urlToImage ? `<img src="${article.urlToImage}" style="max-width: 100%; height: auto; border-radius: 4px; margin-bottom: 8px;">` : '';

            newsItem.innerHTML = `
                ${newsImage}
                <h3><a href="${article.url}" target="_blank">${article.title}</a></h3>
                <p>${article.description || 'no description'}</p>
                <span class="source">source: ${article.source.name}</span>
            `;

            newsContainer.appendChild(newsItem);
        });

    } catch (error) {
        console.error("problem while getting news", error.message);
        newsContainer.innerHTML = `<p class="error">${error.message}</p>`;
    }
}

// =======================================================
// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªØ­Ø±ÙŠÙƒ (Draggable) - Vanilla JS
// =======================================================
function makeElementDraggable(element, dragHandle) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    const handleToUse = dragHandle || element; 
    
    handleToUse.onmousedown = dragMouseDown;
    handleToUse.style.cursor = 'grab';

    function dragMouseDown(e) {
        e = e || window.event;
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø±ÙˆØ± Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        if (e.target.closest('.close-btn')) return; 
        
        e.preventDefault();
        
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        element.style.top = (element.offsetTop - pos2) + "px";
        element.style.left = (element.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }
}


// =======================================================
// ğŸ’¥ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙˆØ±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ DOM)
// =======================================================
document.addEventListener('DOMContentLoaded', () => {
    
    // 1. ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù† localStorage)
    const displayElements = document.querySelectorAll('.DisplayName');
    const savedName = localStorage.getItem('userName');
    if (savedName) {
        displayElements.forEach(element => {
            element.textContent = savedName;
        });
    }

    // 2. Ø¬Ù„Ø¨ Ø¹Ù†Ø§ØµØ± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
    const newsLaunchIcon = document.getElementById('news-launch-icon');
    newsWindowElement = document.getElementById('news-feed-window'); 
    const closeNewsButton = document.getElementById('close-news-button');

    // 3. Ø¬Ù„Ø¨ Ø¹Ù†Ø§ØµØ± Ù†Ø§ÙØ°Ø© D Apps
    const dAppsLaunchIcon = document.getElementById('d-apps-launch-icon');
    dAppsWindowElement = document.getElementById('d-apps-window'); 
    const closeDAppsButton = document.getElementById('close-d-apps-button');
    
    // 4. Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
    if (newsLaunchIcon && newsWindowElement && closeNewsButton) {
        newsLaunchIcon.addEventListener('click', openNewsWindow);
        closeNewsButton.addEventListener('click', closeNewsWindow);
    }

    // 5. Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ù†Ø§ÙØ°Ø© D Apps
    if (dAppsLaunchIcon && dAppsWindowElement && closeDAppsButton) {
        dAppsLaunchIcon.addEventListener('click', openDAppsWindow);
        closeDAppsButton.addEventListener('click', closeDAppsWindow);
    }

    // 6. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± 
    const newsHandle = newsWindowElement ? newsWindowElement.querySelector('.drag-handle') : null;
    if (newsWindowElement && newsHandle) {
        makeElementDraggable(newsWindowElement, newsHandle);
    }
    
    // 7. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© D Apps
    const dAppsHandle = dAppsWindowElement ? dAppsWindowElement.querySelector('.drag-handle') : null;
    if (dAppsWindowElement && dAppsHandle) {
        makeElementDraggable(dAppsWindowElement, dAppsHandle);
    }
    
    // 8. ØªØ´ØºÙŠÙ„ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
    updateTime();
    updateDate();
    setInterval(updateTime, 1000); 
});